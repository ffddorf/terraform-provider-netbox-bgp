---
services:
  postgres:
    image: postgres:18-alpine
    environment:
      - POSTGRES_USER=netbox
      - POSTGRES_PASSWORD=netbox
      - POSTGRES_DB=netbox
    volumes:
      - ./integration/seed.sql:/docker-entrypoint-initdb.d/seed.sql

  redis:
    image: redis:8-alpine
  netbox: &netbox-base
    build:
      context: integration
      args:
        # renovate: datasource=github-releases depName=netbox-community/netbox
        NETBOX_VERSION: ${NETBOX_VERSION:-4.4.6}
        # renovate: datasource=github-releases depName=netbox-community/netbox-bgp
        NETBOX_BGP_VERSION: ${NETBOX_BGP_VERSION:-0.17.0}
    depends_on:
      - postgres
      - redis
    ports:
      - 8001:8080
    environment:
      #DEBUG: "True"
      CORS_ORIGIN_ALLOW_ALL: "True"
      DB_NAME: netbox
      DB_USER: netbox
      DB_PASSWORD: netbox
      DB_HOST: postgres
      REDIS_HOST: redis
      REDIS_DATABASE: "0"
      REDIS_SSL: "false"
      REDIS_CACHE_HOST: redis
      REDIS_CACHE_DATABASE: "1"
      REDIS_CACHE_SSL: false
      SECRET_KEY: 0123456789abcdefghij0123456789abcdefghij0123456789
      SKIP_STARTUP_SCRIPTS: "false"
      SKIP_SUPERUSER: "false"
      SUPERUSER_NAME: admin
      SUPERUSER_EMAIL: admin@example.com
      SUPERUSER_PASSWORD: admin
      SUPERUSER_API_TOKEN: ${NETBOX_API_TOKEN:-0123456789abcdef0123456789abcdef01234567}
    volumes:
      - netbox-media:/media
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/login/"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

  netbox-worker:
    <<: *netbox-base
    healthcheck: {}
    ports: []
    command:
      - /opt/netbox/venv/bin/python
      - /opt/netbox/netbox/manage.py
      - rqworker

volumes:
  netbox-media:
